<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0f1720">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FridgeMate">
  <link rel="manifest" href="manifest.json">
  <title>FridgeMate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0f1720;--surface:#1a2332;--surface2:#222f40;--surface3:#2a3a4e;
      --border:#2d3d52;--text:#e8edf3;--muted:#8899ad;--dim:#5a6d82;
      --accent:#4fc3f7;--accent-g:rgba(79,195,247,0.12);
      --fridge:#4fc3f7;--fridge-bg:rgba(79,195,247,0.1);
      --freezer:#b388ff;--freezer-bg:rgba(179,136,255,0.1);
      --green:#66bb6a;--amber:#ffa726;--red:#ef5350;
      --green-bg:rgba(102,187,106,0.08);--amber-bg:rgba(255,167,38,0.08);--red-bg:rgba(239,83,80,0.1);
      --r:14px;--rs:10px;
      --sab:env(safe-area-inset-bottom,0px)
    }
    body{
      font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);
      min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased
    }

    /* === SYNC STATUS BAR === */
    .sync-bar{
      position:fixed;top:0;left:0;right:0;z-index:500;padding:6px 20px;font-size:12px;
      font-weight:600;text-align:center;transform:translateY(-100%);transition:transform .3s;
      letter-spacing:.3px
    }
    .sync-bar.show{transform:translateY(0)}
    .sync-bar.syncing{background:var(--accent);color:var(--bg)}
    .sync-bar.offline{background:var(--amber);color:var(--bg)}
    .sync-bar.error{background:var(--red);color:#fff}

    /* === AUTH SCREEN === */
    .auth-screen{
      position:fixed;inset:0;z-index:400;background:var(--bg);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:40px;text-align:center;transition:opacity .3s
    }
    .auth-screen.hidden{opacity:0;pointer-events:none}
    .auth-logo{font-family:'Outfit',sans-serif;font-size:32px;font-weight:700;margin-bottom:8px}
    .auth-logo span{color:var(--accent)}
    .auth-sub{color:var(--muted);font-size:15px;margin-bottom:40px;line-height:1.5}
    .google-btn{
      display:flex;align-items:center;gap:12px;padding:14px 28px;
      background:#fff;border:none;border-radius:var(--r);cursor:pointer;
      font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;color:#333;
      box-shadow:0 2px 12px rgba(0,0,0,.2);transition:transform .12s
    }
    .google-btn:active{transform:scale(.96)}
    .google-btn svg{width:20px;height:20px}
    .auth-skip{
      margin-top:20px;background:0;border:0;color:var(--dim);font-family:'DM Sans',sans-serif;
      font-size:13px;cursor:pointer;padding:10px;text-decoration:underline
    }
    .auth-skip:active{color:var(--muted)}

    /* === HEADER === */
    .header{
      position:sticky;top:0;z-index:100;
      background:rgba(15,23,32,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);padding:14px 20px 14px
    }
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .logo{font-family:'Outfit',sans-serif;font-size:22px;font-weight:700;letter-spacing:-0.5px}
    .logo span{color:var(--accent)}
    .header-right{display:flex;align-items:center;gap:12px}
    .header-stats{display:flex;gap:16px;font-size:12px;color:var(--muted)}
    .header-stats b{color:var(--text);font-weight:600}
    .header-stats .warn{color:var(--amber)}
    .user-avatar{
      width:30px;height:30px;border-radius:50%;border:2px solid var(--border);cursor:pointer;
      object-fit:cover;transition:border-color .2s
    }
    .user-avatar:active{border-color:var(--accent)}
    .user-btn{
      width:30px;height:30px;border-radius:50%;border:2px solid var(--border);cursor:pointer;
      background:var(--surface2);color:var(--muted);display:flex;align-items:center;justify-content:center;
      font-size:14px;transition:border-color .2s
    }
    .user-btn:active{border-color:var(--accent)}

    /* === USER MENU === */
    .user-menu{
      position:absolute;top:calc(100% + 8px);right:20px;background:var(--surface);
      border:1px solid var(--border);border-radius:var(--rs);padding:8px;z-index:150;
      min-width:200px;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none
    }
    .user-menu.open{display:block}
    .user-menu-item{
      display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;
      border:0;background:0;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;
      cursor:pointer;width:100%;text-align:left;transition:all .12s
    }
    .user-menu-item:active{background:var(--surface2);color:var(--text)}
    .user-menu-item.danger{color:var(--red)}
    .user-menu-email{padding:8px 12px;font-size:11px;color:var(--dim);border-bottom:1px solid var(--border);margin-bottom:4px}

    .tabs{display:flex;gap:4px;background:var(--surface);border-radius:var(--rs);padding:3px}
    .tab{
      flex:1;padding:10px 6px;border:none;border-radius:8px;background:0;
      color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;
      cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:5px
    }
    .tab.active{background:var(--surface2);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.2)}
    .tab .badge{font-size:11px;background:var(--border);padding:1px 7px;border-radius:20px;font-weight:600}
    .tab.active .badge{background:var(--accent);color:var(--bg)}
    .controls{padding:12px 20px 4px;display:flex;gap:8px}
    .search-wrap{flex:1;position:relative}
    .search-wrap svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--dim);pointer-events:none}
    .search-wrap input{
      width:100%;padding:11px 12px 11px 38px;background:var(--surface);border:1px solid var(--border);
      border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:0;transition:border-color .2s
    }
    .search-wrap input::placeholder{color:var(--dim)}
    .search-wrap input:focus{border-color:var(--accent)}
    .ctrl-btn{
      padding:11px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);
      color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:5px;
      font-family:'DM Sans',sans-serif;font-size:12px;white-space:nowrap;transition:all .15s
    }
    .ctrl-btn:active{background:var(--surface2)}
    .ctrl-btn.active-sort{border-color:var(--accent);color:var(--accent)}
    .cats{padding:8px 20px;display:flex;gap:6px;overflow-x:auto;scrollbar-width:none}
    .cats::-webkit-scrollbar{display:none}
    .cpill{
      flex-shrink:0;padding:6px 13px;background:var(--surface);border:1px solid var(--border);
      border-radius:20px;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:12px;
      font-weight:500;cursor:pointer;transition:all .2s
    }
    .cpill.active{background:var(--accent-g);border-color:var(--accent);color:var(--accent)}
    .list{padding:6px 20px;padding-bottom:calc(90px + var(--sab))}
    .card{
      background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
      padding:14px 14px 14px 18px;margin-bottom:8px;display:flex;align-items:center;gap:12px;
      position:relative;overflow:hidden;transition:all .15s;animation:fadeIn .25s ease
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
    .card.s-green::before{background:var(--green)}
    .card.s-amber::before{background:var(--amber)}
    .card.s-red::before{background:var(--red)}
    .card.s-expired{opacity:.55}
    .card.s-expired::before{background:var(--red)}
    .ic{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0}
    .card.l-fridge .ic{background:var(--fridge-bg)}
    .card.l-freezer .ic{background:var(--freezer-bg)}
    .info{flex:1;min-width:0}
    .info .name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .info .meta{display:flex;align-items:center;gap:8px;margin-top:2px;font-size:12px;color:var(--muted)}
    .loc-tag{font-size:10px;padding:2px 7px;border-radius:5px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
    .loc-tag.fridge{background:var(--fridge-bg);color:var(--fridge)}
    .loc-tag.freezer{background:var(--freezer-bg);color:var(--freezer)}
    .right{text-align:right;flex-shrink:0}
    .right .qty{font-size:15px;font-weight:600}
    .right .exp{font-size:11px;margin-top:1px;font-weight:500}
    .exp.green{color:var(--green)}.exp.amber{color:var(--amber)}.exp.red{color:var(--red)}
    .actions{display:flex;gap:2px;flex-shrink:0;margin-left:4px}
    .abtn{
      width:32px;height:32px;border:0;border-radius:8px;background:0;color:var(--dim);
      cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s
    }
    .abtn:active{background:var(--surface3);color:var(--text)}
    .abtn.del:active{color:var(--red)}
    .empty{text-align:center;padding:60px 20px;color:var(--dim)}
    .empty .ei{font-size:48px;margin-bottom:14px;opacity:.4}
    .empty p{font-size:14px;line-height:1.6}
    .fab{
      position:fixed;bottom:calc(22px + var(--sab));right:20px;width:58px;height:58px;
      border-radius:18px;background:var(--accent);border:0;color:var(--bg);font-size:28px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 20px rgba(79,195,247,.35);z-index:90;transition:transform .12s
    }
    .fab:active{transform:scale(.9)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;opacity:0;pointer-events:none;transition:opacity .25s}
    .overlay.open{opacity:1;pointer-events:all}
    .sheet{
      position:fixed;bottom:0;left:0;right:0;z-index:201;background:var(--surface);
      border-radius:22px 22px 0 0;padding:10px 22px calc(22px + var(--sab));
      transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1);
      max-height:92dvh;overflow-y:auto
    }
    .sheet.open{transform:translateY(0)}
    .sheet-handle{width:36px;height:4px;background:var(--border);border-radius:4px;margin:0 auto 18px}
    .sheet-title{font-family:'Outfit',sans-serif;font-size:19px;font-weight:600;margin-bottom:18px}
    .fg{margin-bottom:16px}
    .fl{display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .fi{
      width:100%;padding:13px 14px;background:var(--bg);border:1px solid var(--border);
      border-radius:var(--rs);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;
      outline:0;transition:border-color .2s
    }
    .fi:focus{border-color:var(--accent)}
    .fi::placeholder{color:var(--dim)}
    .frow{display:flex;gap:10px}
    .frow .fg{flex:1}
    .toggle-row{display:flex;gap:8px}
    .topt{
      flex:1;padding:12px 8px;border:2px solid var(--border);border-radius:var(--rs);background:0;
      color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;
      cursor:pointer;text-align:center;transition:all .2s
    }
    .topt.fr.active{border-color:var(--fridge);background:var(--fridge-bg);color:var(--fridge)}
    .topt.fz.active{border-color:var(--freezer);background:var(--freezer-bg);color:var(--freezer)}
    .cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .copt{
      padding:10px 6px;border:2px solid var(--border);border-radius:var(--rs);background:0;
      color:var(--muted);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;
      text-align:center;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px
    }
    .copt .ce{font-size:17px}
    .copt.active{border-color:var(--accent);background:var(--accent-g);color:var(--accent)}
    .submit-btn{
      width:100%;padding:15px;border:0;border-radius:var(--r);background:var(--accent);
      color:var(--bg);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;
      cursor:pointer;margin-top:8px;transition:opacity .15s
    }
    .submit-btn:active{opacity:.85}
    .delete-btn{
      width:100%;padding:13px;border:2px solid var(--red);border-radius:var(--r);background:0;
      color:var(--red);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;
      cursor:pointer;margin-top:8px;transition:all .15s
    }
    .delete-btn:active{background:var(--red-bg)}
    .sort-drop{
      position:absolute;top:calc(100% + 6px);right:0;background:var(--surface);border:1px solid var(--border);
      border-radius:var(--rs);padding:6px;z-index:150;min-width:180px;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none
    }
    .sort-drop.open{display:block}
    .sort-opt{
      display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;
      border:0;background:0;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;
      cursor:pointer;width:100%;text-align:left;transition:all .12s
    }
    .sort-opt:active{background:var(--surface2);color:var(--text)}
    .sort-opt.active{color:var(--accent)}
    .sort-container{position:relative}
    .confirm-dialog{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.92);
      background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
      padding:24px;z-index:300;min-width:280px;text-align:center;
      opacity:0;pointer-events:none;transition:all .2s
    }
    .confirm-dialog.open{opacity:1;pointer-events:all;transform:translate(-50%,-50%) scale(1)}
    .confirm-dialog h3{font-family:'Outfit',sans-serif;font-size:17px;margin-bottom:8px}
    .confirm-dialog p{font-size:13px;color:var(--muted);margin-bottom:18px}
    .confirm-btns{display:flex;gap:10px}
    .confirm-btns button{
      flex:1;padding:12px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;
      font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;border:0
    }
    .cbtn-cancel{background:var(--surface2);color:var(--text)}
    .cbtn-delete{background:var(--red);color:#fff}

    /* === SETUP BANNER === */
    .setup-banner{
      margin:12px 20px;padding:16px;background:var(--amber-bg);border:1px solid rgba(255,167,38,0.3);
      border-radius:var(--r);font-size:13px;color:var(--amber);line-height:1.5
    }
    .setup-banner b{display:block;margin-bottom:4px;font-size:14px}
    .setup-banner code{
      background:rgba(0,0,0,.3);padding:2px 6px;border-radius:4px;font-size:11px;
      word-break:break-all
    }
    .setup-banner .dismiss{
      background:0;border:0;color:var(--amber);font-family:'DM Sans',sans-serif;
      font-size:12px;cursor:pointer;text-decoration:underline;margin-top:8px;padding:0
    }
  </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="auth-screen" id="authScreen">
  <div class="auth-logo">Fridge<span>Mate</span></div>
  <div class="auth-sub">Track what's in your fridge &amp; freezer.<br>Sign in to sync across all your devices.</div>
  <button class="google-btn" id="googleSignIn" onclick="signInWithGoogle()">
    <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
    Sign in with Google
  </button>
  <button class="auth-skip" onclick="skipAuth()">Use offline only (no sync)</button>
</div>

<!-- SYNC STATUS -->
<div class="sync-bar" id="syncBar"></div>

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div class="logo">Fridge<span>Mate</span></div>
    <div class="header-right">
      <div class="header-stats">
        <span><b id="totalCount">0</b> items</span>
        <span class="warn" id="expiringWarn" style="display:none">‚ö† <b id="expiringCount">0</b> expiring</span>
      </div>
      <div style="position:relative">
        <img class="user-avatar" id="userAvatar" style="display:none" onclick="toggleUserMenu()">
        <button class="user-btn" id="userBtn" onclick="toggleUserMenu()">üë§</button>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-email" id="userEmail">Not signed in</div>
          <button class="user-menu-item" id="menuSignIn" onclick="signInWithGoogle();toggleUserMenu()">üîë Sign in to sync</button>
          <button class="user-menu-item" id="menuSignOut" style="display:none" onclick="signOut();toggleUserMenu()">üö™ Sign out</button>
          <button class="user-menu-item danger" onclick="exportData();toggleUserMenu()">üì§ Export data (JSON)</button>
        </div>
      </div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-loc="all" onclick="setTab(this)">All <span class="badge" id="badgeAll">0</span></button>
    <button class="tab" data-loc="fridge" onclick="setTab(this)">‚ùÑÔ∏è Fridge <span class="badge" id="badgeFridge">0</span></button>
    <button class="tab" data-loc="freezer" onclick="setTab(this)">üßä Freezer <span class="badge" id="badgeFreezer">0</span></button>
  </div>
</div>

<!-- SETUP BANNER (shown when Firebase not configured) -->
<div class="setup-banner" id="setupBanner" style="display:none">
  <b>‚öôÔ∏è Firebase not configured yet</b>
  You're running in offline-only mode. To enable cross-device sync, add your Firebase config to the <code>FIREBASE_CONFIG</code> object in index.html. See the README for a step-by-step guide.
  <br><button class="dismiss" onclick="this.parentElement.style.display='none'">Dismiss</button>
</div>

<div class="controls">
  <div class="search-wrap">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="searchInput" placeholder="Search items..." oninput="renderList()">
  </div>
  <div class="sort-container">
    <button class="ctrl-btn" id="sortBtn" onclick="toggleSort()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M3 6h18M3 12h12M3 18h6"/></svg>
      Sort
    </button>
    <div class="sort-drop" id="sortDrop">
      <button class="sort-opt active" data-sort="expiry-asc" onclick="setSort(this)">üìÖ Expiry (soonest)</button>
      <button class="sort-opt" data-sort="expiry-desc" onclick="setSort(this)">üìÖ Expiry (latest)</button>
      <button class="sort-opt" data-sort="name-asc" onclick="setSort(this)">üî§ Name (A‚ÜíZ)</button>
      <button class="sort-opt" data-sort="name-desc" onclick="setSort(this)">üî§ Name (Z‚ÜíA)</button>
      <button class="sort-opt" data-sort="added-desc" onclick="setSort(this)">üïê Recently added</button>
      <button class="sort-opt" data-sort="category" onclick="setSort(this)">üìÇ Category</button>
    </div>
  </div>
</div>

<div class="cats" id="catBar"></div>
<div class="list" id="itemList"></div>
<button class="fab" onclick="openSheet()">+</button>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title" id="sheetTitle">Add Item</div>
  <div class="fg">
    <label class="fl">Item name</label>
    <input class="fi" id="fName" placeholder="e.g. Chicken breast" autocomplete="off">
  </div>
  <div class="frow">
    <div class="fg">
      <label class="fl">Quantity</label>
      <input class="fi" id="fQty" type="number" inputmode="numeric" placeholder="1" min="1">
    </div>
    <div class="fg">
      <label class="fl">Use by date</label>
      <input class="fi" id="fDate" type="date">
    </div>
  </div>
  <div class="fg">
    <label class="fl">Storage location</label>
    <div class="toggle-row">
      <button class="topt fr active" onclick="pickLoc(this,'fridge')">‚ùÑÔ∏è Fridge</button>
      <button class="topt fz" onclick="pickLoc(this,'freezer')">üßä Freezer</button>
    </div>
  </div>
  <div class="fg">
    <label class="fl">Category</label>
    <div class="cat-grid" id="catGrid"></div>
  </div>
  <button class="submit-btn" id="submitBtn" onclick="saveItem()">Add Item</button>
  <button class="delete-btn" id="deleteBtn" style="display:none" onclick="confirmDelete()">Delete Item</button>
</div>

<div class="overlay" id="confirmOverlay" onclick="cancelDelete()"></div>
<div class="confirm-dialog" id="confirmDialog">
  <h3>Delete item?</h3>
  <p id="confirmText">This can't be undone.</p>
  <div class="confirm-btns">
    <button class="cbtn-cancel" onclick="cancelDelete()">Cancel</button>
    <button class="cbtn-delete" onclick="doDelete()">Delete</button>
  </div>
</div>

<!-- Firebase SDK (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// =====================================================================
// üîß FIREBASE CONFIG ‚Äî Replace with your own from Firebase Console
// =====================================================================
const FIREBASE_CONFIG = {
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

// =====================================================================
// STATE
// =====================================================================
const CATEGORIES=[
  {id:'dairy',emoji:'ü•õ',label:'Dairy'},{id:'meat',emoji:'ü•©',label:'Meat'},
  {id:'veg',emoji:'ü•¨',label:'Veg'},{id:'fruit',emoji:'üçé',label:'Fruit'},
  {id:'drinks',emoji:'ü•§',label:'Drinks'},{id:'leftovers',emoji:'üç±',label:'Leftovers'},
  {id:'condiments',emoji:'ü´ô',label:'Sauces'},{id:'bakery',emoji:'üçû',label:'Bakery'},
  {id:'other',emoji:'üì¶',label:'Other'}
];

let items=[], currentTab='all', currentSort='expiry-asc', currentCat='all',
    editId=null, selectedCat='other', selectedLoc='fridge', deleteTargetId=null;
let localDb, firebaseReady=false, currentUser=null, unsubFirestore=null;

// =====================================================================
// FIREBASE INIT
// =====================================================================
function isFirebaseConfigured() {
  return FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.projectId;
}

function initFirebase() {
  if (!isFirebaseConfigured()) {
    document.getElementById('setupBanner').style.display = '';
    return false;
  }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    firebaseReady = true;
    // Enable offline persistence
    firebase.firestore().enablePersistence({ synchronizeTabs: true }).catch(err => {
      if (err.code === 'failed-precondition') console.warn('Firestore persistence: multiple tabs open');
      else if (err.code === 'unimplemented') console.warn('Firestore persistence: not supported');
    });
    // Auth state listener
    firebase.auth().onAuthStateChanged(user => {
      currentUser = user;
      updateAuthUI();
      if (user) {
        subscribeToFirestore();
      } else {
        if (unsubFirestore) { unsubFirestore(); unsubFirestore = null; }
      }
    });
    return true;
  } catch(e) {
    console.error('Firebase init failed:', e);
    return false;
  }
}

// =====================================================================
// AUTH
// =====================================================================
function signInWithGoogle() {
  if (!firebaseReady) {
    alert('Firebase is not configured. Add your config to FIREBASE_CONFIG in index.html first.\n\nSee the README for instructions.');
    return;
  }
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).catch(err => {
    // Fallback to redirect for mobile
    if (err.code === 'auth/popup-blocked' || err.code === 'auth/popup-closed-by-user') {
      firebase.auth().signInWithRedirect(provider);
    } else {
      console.error('Auth error:', err);
      showSyncBar('Sign in failed: ' + err.message, 'error');
    }
  });
}

function signOut() {
  if (!firebaseReady) return;
  if (unsubFirestore) { unsubFirestore(); unsubFirestore = null; }
  firebase.auth().signOut();
  currentUser = null;
  updateAuthUI();
}

function skipAuth() {
  document.getElementById('authScreen').classList.add('hidden');
  localStorage.setItem('fm_skipped_auth', '1');
}

function updateAuthUI() {
  const avatar = document.getElementById('userAvatar');
  const btn = document.getElementById('userBtn');
  const email = document.getElementById('userEmail');
  const signInBtn = document.getElementById('menuSignIn');
  const signOutBtn = document.getElementById('menuSignOut');

  if (currentUser) {
    document.getElementById('authScreen').classList.add('hidden');
    if (currentUser.photoURL) {
      avatar.src = currentUser.photoURL;
      avatar.style.display = '';
      btn.style.display = 'none';
    }
    email.textContent = currentUser.email || 'Signed in';
    signInBtn.style.display = 'none';
    signOutBtn.style.display = '';
  } else {
    avatar.style.display = 'none';
    btn.style.display = '';
    email.textContent = 'Not signed in';
    signInBtn.style.display = '';
    signOutBtn.style.display = 'none';
    // Show auth screen only if not skipped
    if (!localStorage.getItem('fm_skipped_auth') && firebaseReady) {
      document.getElementById('authScreen').classList.remove('hidden');
    }
  }
}

function toggleUserMenu() {
  document.getElementById('userMenu').classList.toggle('open');
}

// =====================================================================
// FIRESTORE SYNC
// =====================================================================
function getUserCollection() {
  if (!firebaseReady || !currentUser) return null;
  return firebase.firestore().collection('users').doc(currentUser.uid).collection('items');
}

function subscribeToFirestore() {
  const col = getUserCollection();
  if (!col) return;

  showSyncBar('Syncing...', 'syncing');

  unsubFirestore = col.onSnapshot(snapshot => {
    items = [];
    snapshot.forEach(doc => {
      items.push({ id: doc.id, ...doc.data() });
    });
    // Also update local IndexedDB as cache
    saveAllToLocal();
    renderList();
    showSyncBar('Synced', 'syncing');
    setTimeout(() => hideSyncBar(), 1500);
  }, err => {
    console.error('Firestore error:', err);
    showSyncBar('Sync error ‚Äî using local data', 'error');
    setTimeout(() => hideSyncBar(), 3000);
  });
}

async function firestorePut(item) {
  const col = getUserCollection();
  if (!col) return;
  const { id, ...data } = item;
  try {
    await col.doc(id).set(data);
  } catch(e) {
    console.warn('Firestore write queued (offline):', e.message);
  }
}

async function firestoreDelete(id) {
  const col = getUserCollection();
  if (!col) return;
  try {
    await col.doc(id).delete();
  } catch(e) {
    console.warn('Firestore delete queued (offline):', e.message);
  }
}

// =====================================================================
// SYNC BAR
// =====================================================================
function showSyncBar(msg, type) {
  const bar = document.getElementById('syncBar');
  bar.textContent = msg;
  bar.className = 'sync-bar show ' + type;
}
function hideSyncBar() {
  document.getElementById('syncBar').classList.remove('show');
}

// =====================================================================
// LOCAL INDEXEDDB (fallback + cache)
// =====================================================================
function openLocalDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open('FridgeMateDB', 1);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('items')) d.createObjectStore('items', { keyPath: 'id' });
    };
    r.onsuccess = e => { localDb = e.target.result; res(); };
    r.onerror = e => rej(e);
  });
}
function loadFromLocal() {
  return new Promise((res, rej) => {
    const tx = localDb.transaction('items', 'readonly'), s = tx.objectStore('items'), r = s.getAll();
    r.onsuccess = () => { items = r.result || []; res(); };
    r.onerror = e => rej(e);
  });
}
function localPut(item) {
  return new Promise((res, rej) => {
    const tx = localDb.transaction('items', 'readwrite');
    tx.objectStore('items').put(item);
    tx.oncomplete = () => res();
    tx.onerror = e => rej(e);
  });
}
function localDelete(id) {
  return new Promise((res, rej) => {
    const tx = localDb.transaction('items', 'readwrite');
    tx.objectStore('items').delete(id);
    tx.oncomplete = () => res();
    tx.onerror = e => rej(e);
  });
}
function saveAllToLocal() {
  if (!localDb) return;
  const tx = localDb.transaction('items', 'readwrite');
  const store = tx.objectStore('items');
  store.clear();
  items.forEach(item => store.put(item));
}

// =====================================================================
// UNIFIED DATA OPS (writes to both Firestore + local)
// =====================================================================
async function dataPut(item) {
  await localPut(item);
  if (firebaseReady && currentUser) await firestorePut(item);
}
async function dataDelete(id) {
  await localDelete(id);
  if (firebaseReady && currentUser) await firestoreDelete(id);
}

// =====================================================================
// EXPORT
// =====================================================================
function exportData() {
  const data = JSON.stringify(items, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'fridgemate-export.json';
  a.click(); URL.revokeObjectURL(url);
}

// =====================================================================
// UTILS
// =====================================================================
function daysUntil(d){if(!d)return Infinity;const t=new Date;t.setHours(0,0,0,0);return Math.ceil((new Date(d+'T00:00:00')-t)/864e5)}
function expiryStatus(d){const n=daysUntil(d);if(n<0)return'expired';if(n<=2)return'red';if(n<=5)return'amber';return'green'}
function expiryLabel(d){if(!d)return'No date';const n=daysUntil(d);if(n<0)return`Expired ${Math.abs(n)}d ago`;if(n===0)return'Today';if(n===1)return'Tomorrow';return`${n} days`}
function formatDate(d){if(!d)return'';return new Date(d+'T00:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'short'})}
function getCatEmoji(c){const f=CATEGORIES.find(x=>x.id===c);return f?f.emoji:'üì¶'}
function uuid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}
function escHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// =====================================================================
// UI LOGIC (same as before)
// =====================================================================
function setTab(el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');currentTab=el.dataset.loc;renderList()}

function toggleSort(){document.getElementById('sortDrop').classList.toggle('open')}
function setSort(el){
  document.querySelectorAll('.sort-opt').forEach(o=>o.classList.remove('active'));
  el.classList.add('active');currentSort=el.dataset.sort;
  document.getElementById('sortDrop').classList.remove('open');
  document.getElementById('sortBtn').classList.toggle('active-sort',currentSort!=='expiry-asc');
  renderList()
}

function buildCatBar(){
  document.getElementById('catBar').innerHTML=
    `<button class="cpill active" data-cat="all" onclick="setCat(this)">All</button>`+
    CATEGORIES.map(c=>`<button class="cpill" data-cat="${c.id}" onclick="setCat(this)">${c.emoji} ${c.label}</button>`).join('')
}
function setCat(el){document.querySelectorAll('.cpill').forEach(p=>p.classList.remove('active'));el.classList.add('active');currentCat=el.dataset.cat;renderList()}

function buildCatGrid(){
  document.getElementById('catGrid').innerHTML=CATEGORIES.map(c=>
    `<button class="copt" data-cat="${c.id}" onclick="pickCat(this)"><span class="ce">${c.emoji}</span>${c.label}</button>`
  ).join('')
}
function pickCat(el){document.querySelectorAll('.copt').forEach(o=>o.classList.remove('active'));el.classList.add('active');selectedCat=el.dataset.cat}
function pickLoc(el,loc){document.querySelectorAll('.topt').forEach(o=>o.classList.remove('active'));el.classList.add('active');selectedLoc=loc}

function renderList(){
  const search=document.getElementById('searchInput').value.toLowerCase().trim();
  let f=items.filter(i=>{
    if(currentTab!=='all'&&i.location!==currentTab)return false;
    if(currentCat!=='all'&&i.category!==currentCat)return false;
    if(search&&!i.name.toLowerCase().includes(search))return false;
    return true
  });
  f.sort((a,b)=>{
    switch(currentSort){
      case'expiry-asc':return(daysUntil(a.useBy)||9999)-(daysUntil(b.useBy)||9999);
      case'expiry-desc':return(daysUntil(b.useBy)||-9999)-(daysUntil(a.useBy)||-9999);
      case'name-asc':return a.name.localeCompare(b.name);
      case'name-desc':return b.name.localeCompare(a.name);
      case'added-desc':return(b.addedAt||0)-(a.addedAt||0);
      case'category':return(a.category||'').localeCompare(b.category||'')||(daysUntil(a.useBy)||9999)-(daysUntil(b.useBy)||9999);
      default:return 0
    }
  });
  const list=document.getElementById('itemList');
  if(!f.length){
    list.innerHTML=`<div class="empty"><div class="ei">${search?'üîç':'üçΩÔ∏è'}</div><p>${search?'No items match your search':'Nothing here yet.<br>Tap + to add your first item.'}</p></div>`;
    updateStats();return
  }
  list.innerHTML=f.map(item=>{
    const st=expiryStatus(item.useBy),sc=st==='expired'?'s-expired s-red':`s-${st}`,
      el=expiryLabel(item.useBy),ec=st==='expired'?'red':st,df=formatDate(item.useBy);
    return`<div class="card ${sc} l-${item.location}">
      <div class="ic">${getCatEmoji(item.category)}</div>
      <div class="info"><div class="name">${escHtml(item.name)}</div>
        <div class="meta"><span class="loc-tag ${item.location}">${item.location==='fridge'?'‚ùÑÔ∏è Fridge':'üßä Freezer'}</span>${df?`<span>${df}</span>`:''}</div>
      </div>
      <div class="right"><div class="qty">√ó${item.quantity}</div><div class="exp ${ec}">${el}</div></div>
      <div class="actions">
        <button class="abtn" onclick="editItem('${item.id}')" title="Edit"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button class="abtn del" onclick="quickDelete('${item.id}')" title="Delete"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      </div>
    </div>`
  }).join('');
  updateStats()
}

function updateStats(){
  const total=items.length,fc=items.filter(i=>i.location==='fridge').length,zc=items.filter(i=>i.location==='freezer').length;
  const exp=items.filter(i=>{const d=daysUntil(i.useBy);return d>=0&&d<=3}).length;
  const dead=items.filter(i=>daysUntil(i.useBy)<0).length;
  document.getElementById('totalCount').textContent=total;
  document.getElementById('badgeAll').textContent=total;
  document.getElementById('badgeFridge').textContent=fc;
  document.getElementById('badgeFreezer').textContent=zc;
  const w=exp+dead;const we=document.getElementById('expiringWarn');
  if(w>0){we.style.display='';document.getElementById('expiringCount').textContent=w}else{we.style.display='none'}
}

function openSheet(id){
  editId=id||null;
  if(editId){
    const item=items.find(i=>i.id===editId);if(!item)return;
    document.getElementById('sheetTitle').textContent='Edit Item';
    document.getElementById('fName').value=item.name;
    document.getElementById('fQty').value=item.quantity;
    document.getElementById('fDate').value=item.useBy||'';
    selectedLoc=item.location;selectedCat=item.category||'other';
    document.getElementById('submitBtn').textContent='Save Changes';
    document.getElementById('deleteBtn').style.display=''
  }else{
    document.getElementById('sheetTitle').textContent='Add Item';
    document.getElementById('fName').value='';document.getElementById('fQty').value='';
    document.getElementById('fDate').value='';selectedLoc='fridge';selectedCat='other';
    document.getElementById('submitBtn').textContent='Add Item';
    document.getElementById('deleteBtn').style.display='none'
  }
  document.querySelectorAll('.topt').forEach(o=>o.classList.remove('active'));
  document.querySelector(`.topt.${selectedLoc==='fridge'?'fr':'fz'}`).classList.add('active');
  document.querySelectorAll('.copt').forEach(o=>o.classList.remove('active'));
  const cb=document.querySelector(`.copt[data-cat="${selectedCat}"]`);if(cb)cb.classList.add('active');
  document.getElementById('overlay').classList.add('open');
  document.getElementById('sheet').classList.add('open');
  setTimeout(()=>document.getElementById('fName').focus(),350)
}
function closeSheet(){document.getElementById('sheet').classList.remove('open');document.getElementById('overlay').classList.remove('open');editId=null}
function editItem(id){openSheet(id)}

async function saveItem(){
  const name=document.getElementById('fName').value.trim();
  if(!name){document.getElementById('fName').style.borderColor='var(--red)';document.getElementById('fName').focus();setTimeout(()=>document.getElementById('fName').style.borderColor='',1500);return}
  const qty=parseInt(document.getElementById('fQty').value)||1,useBy=document.getElementById('fDate').value||'';
  if(editId){
    const idx=items.findIndex(i=>i.id===editId);
    if(idx>=0){
      Object.assign(items[idx],{name,quantity:qty,useBy,location:selectedLoc,category:selectedCat});
      await dataPut(items[idx])
    }
  }else{
    const item={id:uuid(),name,quantity:qty,useBy,location:selectedLoc,category:selectedCat,addedAt:Date.now()};
    items.push(item);
    await dataPut(item)
  }
  closeSheet();renderList()
}

function quickDelete(id){
  deleteTargetId=id;const item=items.find(i=>i.id===id);
  document.getElementById('confirmText').textContent=`Remove "${item?.name||'this item'}" from your list?`;
  document.getElementById('confirmOverlay').classList.add('open');document.getElementById('confirmDialog').classList.add('open')
}
function confirmDelete(){
  deleteTargetId=editId;const item=items.find(i=>i.id===editId);
  document.getElementById('confirmText').textContent=`Remove "${item?.name||'this item'}" from your list?`;
  document.getElementById('confirmOverlay').classList.add('open');document.getElementById('confirmDialog').classList.add('open')
}
function cancelDelete(){deleteTargetId=null;document.getElementById('confirmOverlay').classList.remove('open');document.getElementById('confirmDialog').classList.remove('open')}
async function doDelete(){
  if(deleteTargetId){
    await dataDelete(deleteTargetId);
    items=items.filter(i=>i.id!==deleteTargetId)
  }
  cancelDelete();closeSheet();renderList()
}

// Close menus on outside click
document.addEventListener('click',e=>{
  const sd=document.getElementById('sortDrop'),sb=document.getElementById('sortBtn');
  if(!sd.contains(e.target)&&!sb.contains(e.target))sd.classList.remove('open');
  const um=document.getElementById('userMenu'),ua=document.getElementById('userAvatar'),ub=document.getElementById('userBtn');
  if(!um.contains(e.target)&&e.target!==ua&&e.target!==ub)um.classList.remove('open');
});

// Online/offline detection
window.addEventListener('online', () => {
  showSyncBar('Back online ‚Äî syncing...', 'syncing');
  setTimeout(() => hideSyncBar(), 2000);
});
window.addEventListener('offline', () => {
  showSyncBar('Offline ‚Äî changes saved locally', 'offline');
  setTimeout(() => hideSyncBar(), 3000);
});

// =====================================================================
// INIT
// =====================================================================
async function init(){
  // Always open local DB first
  await openLocalDB();
  await loadFromLocal();
  buildCatBar();
  buildCatGrid();
  renderList();

  // Try Firebase
  const fbOk = initFirebase();

  // If no firebase or skipped auth, hide auth screen
  if (!fbOk || localStorage.getItem('fm_skipped_auth')) {
    document.getElementById('authScreen').classList.add('hidden');
  }

  // Service worker
  if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
}
init();
</script>
</body>
</html>
